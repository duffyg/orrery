<!DOCTYPE html>
<head>
<meta charset="utf-8" />
<meta name="Orrery" />
<meta name="viewport" content="width=device-width" />
<script src="./js/orrery.js"></script>
</head>
<body class="">

      
<div id="container">
    <canvas id="orrCanvas" width=500 height=500 style='border: 1px #111 solid; background-color: #333;'></canvas>
    <!-- <canvas id="orrCanvas2" width=500 height=500 style='border: 1px #111 solid; background-color: #333;'></canvas> -->
    <canvas id='orrKeyCanvas' width=303 height=500 style='border: 1px #111 solid; background-color: #333;'></canvas>


<b>Controls</b><br/>
<button type="button" title="Animate forwards by day" onclick='rateChanged(this.id)' id='but_ratef'>Play</button>
<button type="button" title="Stop" onclick='rateChanged(this.id)' id='but_ratestop'>Stop</i></button>
<button type="button" title="Today" onclick='changeDate("now")' id='but_stepnow'>Today</button>
<div style="display:none">
    <button type="button" title="Animate backwards by year" onclick='rateChanged(this.id)' id='but_ratebbb'><i class="fa fa-small fa-rotate-180 fa-fast-forward"></i></button>
    <button type="button" title="Animate backwards by month" onclick='rateChanged(this.id)' id='but_ratebb'><i class="fa fa-small fa-backward"></i></button>
    <button type="button" title="Animate backwards by day"  onclick='rateChanged(this.id)' id='but_rateb'><i class="fa fa-small fa-rotate-180 fa-play"></i></button>
    <!-- <button type="button" title="Stop" onclick='rateChanged(this.id)' id='but_ratestop'><i class="fa fa-small fa-stop"></i></button> -->
    <!-- <button type="button" title="Animate forwards by day" onclick='rateChanged(this.id)' id='but_ratef'><i class="fa fa-small fa-play"></i></button> -->
    <button type="button" title="Animate forwards by month" onclick='rateChanged(this.id)' id='but_rateff'><i class="fa fa-small fa-forward"></i></button>
    <button type="button" title="Animate forwards by year" onclick='rateChanged(this.id)' id='but_ratefff'><i class="fa fa-small fa-fast-forward"></i></button>
    <br/>
    <button type="button" title="Skip back a year" onclick='changeDate("-y")' id='but_stepbyr'><i class="fa fa-small fa-angle-left"></i><i class="fa fa-small fa-angle-left"></i><i class="fa fa-small fa-angle-left"></i></button>
    <button type="button" title="Skip back a month" onclick='changeDate("-m")' id='but_stepbmn'><i class="fa fa-small fa-angle-double-left"></i></button>
    <button type="button" title="Skip back a day" onclick='changeDate("-d")' id='but_stepbdy'><i class="fa fa-small fa-angle-left"></i></button>
    <!-- <button type="button" title="Today" onclick='changeDate("now")' id='but_stepnow'>Today</button> -->
    <button type="button" title="Skip forward a day" onclick='changeDate("+d")' id='but_stepfdy'><i class="fa fa-small fa-angle-right"></i></button>
    <button type="button" title="Skip forward a month" alt="Month&gt" onclick='changeDate("+m")' id='but_stepfmn'><i class="fa fa-small fa-angle-double-right"></i></button>
    <button type="button" title="Skip forward a year" onclick='changeDate("+y")' id='but_stepfyr'><i class="fa fa-small fa-angle-right"></i><i class="fa fa-small fa-angle-right"></i><i class="fa fa-small fa-angle-right"></i></button>
</div>

<br/>

<b>Display</b><br/>
<input id='toggleLabel' type='checkbox' checked> Show Labels?&nbsp;&nbsp;<input id='togglePluto' type='checkbox'> Show Pluto?<br/>

<input type='radio' id='innerss' name='rad_scale', value='0.007' checked='checked'> Inner Solar System&nbsp;&nbsp;<input type='radio' id='midss' name='rad_scale', value='0.045'> Visible Solar System&nbsp;&nbsp;<input type='radio' id='outerss' name='rad_scale', value='0.19'> Outer Solar System<br/><br/>
</div>


<script> 

    // ==========================================
    // Basic setup of canvas etc
var orrCanvas = document.getElementById("orrCanvas");
var orrContext = orrCanvas.getContext("2d");

var orrKeyCanv = document.getElementById("orrKeyCanvas");
var orrKeyCont = orrKeyCanv.getContext("2d");

var requestAnimationFrame = window.requestAnimationFrame || 
                                    window.mozRequestAnimationFrame ||
                                    window.webkitRequestAnimationFrame ||
                                    window.msRequestAnimationFrame;


    // ==========================================
    // Helper functions to do scalings etc

   // ----------------------------------------------------
   // Scaling factors and current "date" for displaying
var spaceScale = 0.00006;  // The current spacial scaling from AU to canvas pixels
var spaceScaleDesired = 0.06; // The spacial scale to aim for
var spaceScaleRate = 0.08;  // The multiplicative change in scale per frame

var timeScale = 0.0; // Scaling from "real" time to displayed time (default to stationary).

    // The "date" being displayed (defaults to "now")
var dispDate = new Date();
    // The date and time that the current "rate" starts from (defaults to "now")
var startDate = new Date();
var startTime = (new Date().getTime());
    // The upper and lower limits on the date to display
var minDate = new Date('January 1, 1800');
var maxDate = new Date('December 31, 2200');


    // ----------------------------------------------------
    // Convert from AU coordinate to pixel on the orrCanvas
    
function AU2pix(au, pix) {
  
    var midX,midY;
    midX = orrCanvas.width / 2.0;
    midY = orrCanvas.height / 2.0;
    
    pix[X] = midX + (au[X] / spaceScale);
    pix[Y]  = midY + (au[Y] / spaceScale);
  
}

    // ----------------------------------------------------
    // Convert from time-from-start to "space" time
    
function time2date(startTime, startDate) {
    
    var now = (new Date().getTime());
    var timDif = now - startTime;
    var timscl = (timDif * timeScale) + startDate.getTime();
    if(timscl > maxDate.getTime()) {
	timscl = maxDate.getTime();
	rateChanged('but_ratestop');  // Force it to "stop"
    }
    if(timscl < minDate.getTime()) {
	timscl = minDate.getTime();
	rateChanged('but_ratestop');
    }
    dispDate.setTime(timscl);

} // time2date(startTime)


// ==========================================
// Handlers for buttons
function rateChanged(buttid) {


    // Enable all hte buttons (the one that has beeb selected will be disabled below)
    document.getElementById('but_ratebbb').disabled = false;
    document.getElementById('but_ratebb').disabled = false;
    document.getElementById('but_rateb').disabled = false;
    document.getElementById('but_ratestop').disabled = false;
    document.getElementById('but_ratef').disabled = false;
    document.getElementById('but_rateff').disabled = false;
    document.getElementById('but_ratefff').disabled = false;
    
    
    // Get the rate from the appropraite button

    // 5 days per second: 8.64e5
    // 1 year per second: 3.15e7
    // 10 years per second: 3.15e8
    var newrate;
    switch(buttid) {
    case 'but_ratebbb':
	newrate = -3.15e8;
	break;
    case 'but_ratebb':
	newrate = -3.15e7;
	break;
    case 'but_rateb':
	newrate = -8.64e5;
	break;
    case 'but_ratestop':
	newrate = 0;
	break;
    case 'but_ratef':
	newrate = 8.64e5;
	break;
    case 'but_rateff':
	newrate = 3.15e7;
	break;
    case 'but_ratefff':
	newrate = 3.15e8;
	break;
    }
    
    timeScale = newrate;
    startDate.setTime(dispDate.getTime());
    startTime = (new Date().getTime());

    // Display/enable all the appropraite buttons
    document.getElementById(buttid).disabled = true;

    // If anything other than "stop", disable all the "step" buttons
    var stepst = (newrate != 0);
    document.getElementById('but_stepbyr').disabled = stepst;
    document.getElementById('but_stepbmn').disabled = stepst;
    document.getElementById('but_stepbdy').disabled = stepst;
    document.getElementById('but_stepnow').disabled = stepst;
    document.getElementById('but_stepfdy').disabled = stepst;
    document.getElementById('but_stepfmn').disabled = stepst;
    document.getElementById('but_stepfyr').disabled = stepst;

    
}

function changeDate(act) {

    // Get the current date for changing
    yr = dispDate.getFullYear();
    mn = dispDate.getMonth();
    dy = dispDate.getDate();

    // and a temoprary date to store it all in
    var tmpdate = new Date();
    tmpdate.setFullYear(yr);
    tmpdate.setMonth(mn);
    tmpdate.setDate(dy);

    // Parse the string and see what is says
    switch (act) {
    case "-y":
	yr -= 1;
	tmpdate.setFullYear(yr);
	break;
    case "-m":
	mn -= 1;
	tmpdate.setMonth(mn, dy);
	break;
    case "-d":
	dy -= 1;
	tmpdate.setMonth(mn, dy);
	break;
    case "+y":
	yr += 1;
	tmpdate.setFullYear(yr);
	break;
    case "+m":
	mn += 1;
	tmpdate.setMonth(mn, dy);
	break;
    case "+d":
	dy += 1;
	tmpdate.setMonth(mn, dy);
	break;
    case "now":
	tmpdate = new Date();
	break;
    }

    // And pass it into the system, doing the boundary checks at the same time)
    startDate = tmpdate;
    startTime = (new Date().getTime());
    time2date(startTime, startDate);

}

    // ==========================================
    // Orbital paths
  var orbPath = [];     // The actual paths
  var orbPathStep = 50; // Number of steps on an orbital path

  function createOrbPaths() {

    orbPath = []; // Initiliase to nothing

    var orbp = [], i;
    orbp[0] = 0; // Create a blank value for the sun, which will never be used
    orbPath.push(orbp);

    for(i=1; i<=NUMPLAN+1; i++) { // 0 is for the Sun, +1 is for Pluto
      orbp = PlanetEllipse(i, orbPathStep);
      orbPath.push(orbp);
    }
  } // createOrbPaths()


    // ==========================================
    // Colours etc
  var orbPathCols = ["#ffffee", // Sun (not used)
                     "#999999", // Mercury
                     "#CCCC33", // Venus
                     "#3366FF", // Earth
                     "#FF6666", // Mars
                     "#FFCC33", // Jupiter
                     "#CCCC33", // Saturn
                     "#33CCCC", // Uranus
                     "#33CCFF", // Neptune
		     "#CCCCCC"  // Pluto
                    ];
  var orbPlanetCols = ["#ffff00", // Sun
                       "#666666", // Mercury
                       "#999900", // Venus
                       "#3399FF", // Earth
                       "#CC0000", // Mars
                       "#CC9900", // Jupiter
                       "#CCCC00", // Saturn
                       "#009999", // Uranus
                       "#0099CC", // Neptune
		       "#999999"  // Pluto
                      ];

  var orbLabelCols = ["#ffff00", // Sun
                       "#CCCCCC", // Mercury
                       "#FFFF66", // Venus
                       "#99CCFF", // Earth
                       "#FF6666", // Mars
                       "#FFCC66", // Jupiter
                       "#FFFF66", // Saturn
                       "#66FFFF", // Uranus
                       "#66CCFF", // Neptune
		       "#CCCCCC"  // Pluto
                      ];

var flgPluto; // Do we show Pluto?


    // ==========================================
    // Drawing functions

    // ----------------------------------------------------
    // Draw all the orbitals
function drawOrbitals(plutoFlag) {

    var p, np;
    if(plutoFlag) np = NUMPLAN+1;
    else np = NUMPLAN;
    for(p=1; p<=np; p++) { // 0 is for Sun, +1 is for Pluto

	orrContext.beginPath();
	// Scale the line width based on whether this is only in the centre...
	var widpix;
	var pos = [], posB = [], i;

	AU2pix(orbPath[p][0], pos);
	AU2pix(orbPath[p][orbPathStep>>1], posB);
	widpix = ((pos[X]-posB[X])*(pos[X]-posB[X])) + ((pos[Y]-posB[Y])*(pos[Y]-posB[Y]));
	widpix = Math.sqrt(widpix);
	if(widpix < (orrCanvas.width>>3)) orrContext.lineWidth="1";
	else orrContext.lineWidth="2";
	orrContext.strokeStyle=orbPathCols[p];
	
	AU2pix(orbPath[p][0], pos);
	orrContext.moveTo(pos[X], pos[Y]);
	for(i=1; i<orbPathStep; i++) {
            AU2pix(orbPath[p][i], pos);
            orrContext.lineTo(pos[X], pos[Y]);
	}
	orrContext.closePath();
	orrContext.stroke();
    }
} // function drawOrbitals()

    // ----------------------------------------------------
    // Draw all the planets
function drawPlanets(plutoFlag) {

    var p, np, r, posSun = [];
    var orbpos, pos = [], i;
    orbpos = PlanetPosition(SUN, dispDate);
    AU2pix(orbpos, posSun);
    if(plutoFlag) np = NUMPLAN+1;
    else np = NUMPLAN;
    for(p=np; p>=0; p--) { // 0 is for Sun, +1 is for Pluto. Draw the Sun last

	orrContext.beginPath();
	orbpos = PlanetPosition(p, dispDate);
	AU2pix(orbpos, pos);

	// Calculate a radius that scales very roughly with object radius, but also scales as we zoom in or out.
	// The minimum radius is set tso that everthing (even Pluto) is always visible
	r = 1.5 + (Math.sqrt(PlanetRadius[p]) / (100.0*Math.sqrt(spaceScale)));
	// However make sure that the Sun stays fixed relative to the scale (albeit quite large)
	if(p == 0) {
	    r = 2 + (0.5 / Math.sqrt(spaceScale));
	}
	orrContext.arc(pos[X],pos[Y],r,0,2*Math.PI);
	orrContext.lineWidth="1";
	orrContext.strokeStyle=orbPlanetCols[p];
	orrContext.fillStyle=orbPlanetCols[p];
	orrContext.fill();

	orrContext.stroke();

	// Put a label if this is a decent distance from the Sun
	if(flgLabel) {
	    var diff;
	    if(p != SUN) {
		diff = ((pos[X]-posSun[X]) * (pos[X]-posSun[X])) + ((pos[Y]-posSun[Y]) * (pos[Y]-posSun[Y]));
		diff = Math.sqrt(diff);
	    } else diff = orrCanvas.width;
	    if(diff > (orrCanvas.width/11.5)) {
		orrContext.font = "14px Arial";
		orrContext.fillStyle = orbLabelCols[p];
		orrContext.textAlign="center";
		orrContext.fillText(PlanetName[p], pos[X],pos[Y]-(1.2*r));
	    }
	}
    }
} // function drawPlanets()

function drawKey() {


    var wid, hgt, cwid, chgt;
    wid = orrKeyCanv.width;
    hgt = orrKeyCanv.height;
    cwid = wid / 2;
    chgt = hgt/6;
    
    var x,y;
    // Sun (in the middle at the top. no line)
    x = wid/2;
    y = chgt/2;
    //orrKeyCont.beginPath();
    //orrKeyCont.lineWidth="2"
    //orrKeyCont.strokeStyle = orbPathCols[SUN];
    //orrKeyCont.moveTo(x-(cwid/2),y);
    //orrKeyCont.lineTo(x,y);
    //orrKeyCont.stroke();

    orrKeyCont.beginPath();
    orrKeyCont.arc(x-(cwid/4),y, 6, 0,2.0*Math.PI);
    orrKeyCont.lineWidth="1";
    orrKeyCont.strokeStyle=orbPlanetCols[SUN];
    orrKeyCont.fillStyle=orbPlanetCols[SUN];
    orrKeyCont.fill();
    orrKeyCont.stroke();

    orrKeyCont.font = "14px Arial";
    orrKeyCont.fillStyle = orbLabelCols[SUN];
    orrKeyCont.textAlign = "start"
    orrKeyCont.fillText(PlanetName[SUN], x+4, y+7);

    x = cwid/2;
    y = y + chgt;
    for(var p=1; p<=NUMPLAN+1; p++) {
        if(p == (NUMPLAN+1)) { // Pluto goes in the middle
          x = cwid;
        }
	orrKeyCont.beginPath();
	orrKeyCont.lineWidth="2"
	orrKeyCont.strokeStyle = orbPathCols[p];
	orrKeyCont.moveTo(x-(cwid/2),y);
	orrKeyCont.lineTo(x,y);
	orrKeyCont.stroke();

	orrKeyCont.beginPath();
	orrKeyCont.arc(x-(cwid/4),y, 6, 0,2.0*Math.PI);
	orrKeyCont.lineWidth="1";
	orrKeyCont.strokeStyle=orbPlanetCols[p];
	orrKeyCont.fillStyle=orbPlanetCols[p];
	orrKeyCont.fill();
	orrKeyCont.stroke();

	orrKeyCont.font = "14px Arial";
	orrKeyCont.fillStyle = orbLabelCols[p];
	orrKeyCont.textAlign = "start"
	orrKeyCont.fillText(PlanetName[p], x+4, y+7);

    	x = x + cwid;
	if(x >= wid) {
	    x = cwid/2;
	    y = y + chgt;
	}
}

}


    // ----------------------------------------------------
    // Calculate and store all the orbital paths
createOrbPaths();
 
    // ++++++++++++++TESTING++++++++++++++
    //       Basic orbital motion
function drawAnim() {

       // Clear the canvas ready to redraw
    orrContext.clearRect(0, 0, orrCanvas.width, orrCanvas.height);

       // Add the current date in a nicely formatted way
    var yr, mn, dy, str;
    yr = dispDate.getFullYear();
    mn = dispDate.getMonth()+1;
    dy = dispDate.getDate();
    if(dy<10) str = "0"+dy+"/";
    else str = dy+"/";
    if(mn < 10) str += "0"+mn+"/";
    else str += mn+"/";
    str += yr;
    orrContext.beginPath();
    orrContext.font = "20px Courier New";
    orrContext.fillStyle = "#FFFFCC";
    orrContext.textAlign = "end";
    orrContext.fillText(str, 0.99*orrCanvas.width, 20);

       // See how long we have been since "starttime"
    var time = (new Date().getTime());
    var timeDiff = time - startTime;
    time2date(startTime, startDate);


           // Get the scale from the appropraite "checked" radio button
    var scaleRads = document.getElementsByName("rad_scale");
    for(var i=0; i<scaleRads.length; i++) {
	if(scaleRads[i].checked == true) {
	    spaceScaleDesired = scaleRads[i].value;
	}
    }
    
       // If we are not where we want to be then change where we
       // are. However, as this is multiplcative, there will be no "end"
       // point, so have a final check to ensure convergence when it is
       // very close.
    
    if(spaceScaleDesired != spaceScale) {
	var dif = spaceScale - spaceScaleDesired;
	var frac = Math.abs(dif) / spaceScaleDesired;
	if(frac < 0.005) {
	    spaceScale = spaceScaleDesired;
	} else {
	    spaceScale = spaceScale - (spaceScaleRate * dif);
	}
    }

    // ==== Draw everything using current scale and date ====
    flgPluto = document.getElementById('togglePluto').checked;
    flgLabel = document.getElementById('toggleLabel').checked;
    drawOrbitals(flgPluto);
    drawPlanets(flgPluto);

    requestAnimationFrame(function() {
        drawAnim()
    });
      
}

startTime = (new Date().getTime());
startDate = (new Date());
dispDate = (new Date());
rateChanged('but_ratestop');
drawKey();
drawAnim();
    
 
</script>
</body>
</html>